<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Global Chess Landscape — Revamped</title>

  <!-- Vega -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5.32.0/build/vega.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.12.0/build/vega-lite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.25.0/build/vega-embed.min.js"></script>

  <!-- PureCSS + fonts -->
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.1.0/build/pure-min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="images/favicon.png">

  <style>
    /* desig */
    :root{
      --bg: #0f1720;
      --panel: #0f1a24;
      --muted: #99a0a6;
      --accent: #d9b44a;
      --accent-2: #6fb3ff;
      --card-radius: 12px;
      --max-width: 1180px;
    }

    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(180deg,#07101a 0%, #0f1720 100%);
      color: #e6eef6;
      font-family: "Inter", Arial, sans-serif;
      line-height: 1.5;
      padding-top: 72px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* navigation bar */
    .nav {
      position: fixed; top: 0; left: 0; right: 0;
      display: flex; align-items: center; justify-content: center; gap: 28px;
      height: 64px; z-index: 1100;
      background: linear-gradient(180deg, rgba(8,12,16,0.9), rgba(8,12,16,0.7));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(6px);
    }
    .brand {
      position: absolute; left: 18px; display: flex; gap: 10px; align-items: center; color: var(--muted); font-size: 13px;
    }
    .nav a { color: #e6eef6; font-family: "Barlow Condensed", sans-serif; font-weight: 700; letter-spacing: 0.06em; font-size: 13px; padding: 8px 10px; border-radius: 6px; }
    .nav a.active { color: var(--bg); background: var(--accent); box-shadow: 0 6px 18px rgba(217,180,74,0.08); }

    /* main container */
    .container { max-width: var(--max-width); margin: 0 auto; padding: 40px 20px; }

    /* hero section */
    header.hero { padding: 36px 0 28px 0; text-align: center; margin-bottom: 12px; }
    .hero h1 { font-family: "Barlow Condensed", sans-serif; font-weight: 700; font-size: 36px; margin: 0; letter-spacing: 0.06em; color: var(--accent); }
    .hero p.lead { margin-top: 16px; max-width: 880px; margin-left: auto; margin-right: auto; color: var(--muted); font-size: 15px; }

    /* sections */
    section.section { padding: 56px 0; border-top: 1px solid rgba(255,255,255,0.02); }
    .section .title { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-family: "Barlow Condensed", sans-serif; font-size: 20px; color: var(--accent); letter-spacing: 0.04em; }
    .section .subtitle { color: var(--muted); max-width: 820px; margin-bottom: 18px; font-size: 15px; }

    /* layout for visual + side panel */
    .layout { display: grid; grid-template-columns: 1fr 320px; gap: 24px; align-items: start; }
    @media (max-width: 980px){ .layout { grid-template-columns: 1fr; } }

    /* card / visual box */
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008)); border-radius: var(--card-radius); padding: 14px; box-shadow: 0 6px 18px rgba(2,6,12,0.6); border: 1px solid rgba(255,255,255,0.02); }
    .viz { min-height: 320px; border-radius: 8px; overflow: hidden; background: var(--panel); padding: 8px; }
    .viz .inner { height: 100%; border-radius: 6px; overflow: hidden; background: transparent; }

    /* top list */
    .toplist { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 10px; }
    .toplist li { display: flex; align-items: center; gap: 10px; background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); padding: 10px; border-radius: 8px; font-size: 14px; color: #f2f6fb; }
    .toplist .rank { font-weight: 700; width: 36px; text-align: center; color: var(--accent); }
    .flag { width: 28px; height: auto; border-radius: 3px; object-fit: cover; box-shadow: 0 1px 0 rgba(0,0,0,0.4); }
    .toplist .name { flex: 1; color: #e9f0f8; }
    .toplist .value { font-weight: 600; color: var(--muted); }

    .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .controls select, .controls input[type="range"], .controls input[type="checkbox"] { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: var(--accent-2); padding: 8px 10px; border-radius: 8px; min-width: 160px; font-size: 13px; }
    .controls label { color: var(--muted); font-size: 14px; }

    .caption { color: var(--muted); font-size: 13px; margin-top: 8px; }
    footer.site-foot { padding: 40px 0; text-align: center; color: var(--muted); font-size: 13px; }

    .reveal { opacity: 0; transform: translateY(18px) scale(0.995); transition: all 0.6s cubic-bezier(.2,.9,.3,1); will-change: transform, opacity; }
    .reveal.visible { opacity: 1; transform: translateY(0) scale(1); }

    @media (max-width: 720px) { .nav { padding-left: 14px; padding-right: 14px; } .hero h1 { font-size: 28px; } body { padding-top: 64px; } }
  </style>
</head>
<body>

  <!-- Navigation bar -->
  <nav class="nav" role="navigation" aria-label="Main navigation">
    <div class="brand" aria-hidden="true">
      <img src="images/knight_icon.png" alt="Knight icon" style="width: 50px; height: 35px;">
      <div style="font-size:12px; color:var(--muted);">Global Chess Demographics</div>
    </div>
    <a href="#map-section" class="nav-link active">Map</a>
    <a href="#timeline-section" class="nav-link">Performance</a>
    <a href="#pyramid-section" class="nav-link">Gender</a>
    <a href="#titles-section" class="nav-link">Titled Players</a>
    <a href="#about-section" class="nav-link">About</a>
  </nav>

  <!-- Hero section -->
  <header class="hero container">
    <h1>THE GLOBAL CHESS LANDSCAPE</h1>
    <p class="lead">Explore chess participation, strength, and gender balance around the world. Each section provides context, a visual, and controls to explore the data.</p>
  </header>

  <!-- Map section -->
  <section id="map-section" class="section">
    <div class="container">
      <div class="title">Mapping the Chess World</div>
      <p class="subtitle">Colour shows the selected metric, circle size represents female participation. Use controls to explore different views.</p>

      <div class="layout">
        <div class="card reveal" id="map-card" role="region" aria-label="Map visualization">
          <div class="controls" id="map-controls">
            <label for="map-color">Colour by metric:</label>
            <select id="map-color" aria-label="Select metric for map colour">
              <option value="FIDE Average">Avg FIDE Rating</option>
              <option value="% of Women">% Women</option>
              <option value="Num Players">Total Players</option>
            </select>

            <label><input id="show-centroids" type="checkbox" checked /> Show gender centroids</label>
          </div>

          <div class="viz" id="map"><div class="inner" id="map-inner"></div></div>
          <p class="caption">Brighter map colour = higher metric.</p>
          <p class="caption">Larger circles = more titled female players.</p>
        </div>

        <aside class="card reveal" id="map-toplist" aria-label="Top countries list">
          <h4 style="margin:0 0 12px 0; color:var(--accent); font-family:'Barlow Condensed',sans-serif;">Top 10 by Avg FIDE</h4>
          <ol class="toplist" id="toplist">
            <li style="opacity:0.5;color:var(--muted)">Loading…</li>
          </ol>
          <p class="caption">Countries ranked by the number of FIDE-titled female players.</p>
        </aside>
      </div>
    </div>
  </section>

  <footer class="site-foot">
    Data from KAGGLE and Chess.com. Visualizations created by Edward G. 2025.
  </footer>


<script>
/*  CONFIG */
const COUNTRY_TOPOMAP = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"; // topojson
const STATS_CSV = "data/Chess_Stats.csv";
const CENTROIDS_CSV = "data/Chess_Stats_with_Centroids.csv";
const TOPLIST_COUNT = 10;

let mapView = null;

const keepCols = {
  "Country": "Country",
  "Num Players": "Flag",       
  "Women": "Women",            
  "% of Women": "% of Women", 
  "FIDE Average": "FIDE Average",
  "GMs": "GMs",
  "IMs": "IMs",
  "FMs": "FMs",
  "WGMs": "WGMs",
  "WIMs": "WIMs",
  "WFMs": "WFMs"
};

function splitCSVRow(row) {
  const cols = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < row.length; i++) {
    const c = row[i];
    if (c === '"' && row[i-1] !== '\\') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      cols.push(current);
      current = '';
    } else {
      current += c;
    }
  }
  cols.push(current);
  return cols.map(c => c.replace(/^"|"$/g,''));
}



async function loadCSV(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();

    const rows = text.trim().split(/\r?\n/);
    const headers = rows.shift().split(',').map(h => h.replace(/(^"|"$)/g,'').trim());
    
    return rows.map(r => {
      // split respecting quoted commas
      const cols = splitCSVRow(r);

      const obj = {};
      headers.forEach((h,i) => {
        let cell = (cols[i] || "").replace(/^"|"$/g, "");
        console.log("CELL",h,cell);
        // convert numbers
        const num = Number(cell.replace(/,/g,''));
        obj[h] = (cell === "" ? null : (isNaN(num) ? cell : num));
      });
      return obj;
    });
  } catch (err) {
    console.error("Failed to load CSV", url, err);
    return null;
  }
}

// Build Vega-Lite spec for the map with signals that can be updated
function buildMapSpec() {
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: "container",
    height: 480,
    projection: { type: "equalEarth" },
    params: [
      { name: "colorField", value: "FIDE Average", bind: null },
      { name: "circleScale", value: 1, bind: null },
      { name: "showCentroids", value: true, bind: null }
    ],
    layer: [
      {
        data: {
          url: COUNTRY_TOPOMAP,
          format: { type: "topojson", feature: "countries" }
        },
        transform: [
          { calculate: "datum.properties.name", as: "Country" },
          {
            lookup: "Country",
            from: {
              data: { url: STATS_CSV, format: { type: "csv" } },
              key: "Country",
              fields: ["FIDE Average", "% of Women", "Num Players"]
            },
            as: ["FIDE Average", "% of Women", "Num Players"] // as names will attach fields to geometry datum
          }
        ],
        mark: { type: "geoshape", stroke: "white", strokeWidth: 0.5 },
        encoding: {
          color: {
            field: { signal: "colorField" },
            type: "quantitative",
            scale: { scheme: "viridis" },
            title: { signal: "colorField" }
          },
          tooltip: [
            { field: "Country", type: "nominal", title: "Country" },
            { field: "FIDE Average", type: "quantitative", title: "Avg FIDE" },
            { field: "Num Players", type: "quantitative", title: "Num Players" },
            { field: "% of Women", type: "quantitative", title: "% Women" }
          ]
        }
      },
      {
        // centroid circles layer (separate CSV, plotted by lat/lon)
        data: { url: CENTROIDS_CSV, format: { type: "csv" } },
        transform: [
          // make sure % field is numeric and scaled into a visually-useful range (area)
          { calculate: "toNumber(datum['% of Women']) * circleScale * 50", as: "scaled_size" },
          // allow toggle via param showCentroids — filter expression uses parameter
          { filter: "showCentroids" }
        ],
        mark: { type: "circle", stroke: "white", strokeWidth: 0.7, opacity: 0.75 },
        encoding: {
          longitude: { field: "Longitude", type: "quantitative" },
          latitude: { field: "Latitude", type: "quantitative" },
          size: {
            field: "scaled_size",
            type: "quantitative",
            scale: { range: [30, 1600] },
            legend: { title: "% Women (area scaled)" }
          },
          color: {
            field: { signal: "colorField" }, // let circles color by same metric as map
            type: "quantitative",
            scale: { scheme: "plasma" },
            legend: null
          },
          tooltip: [
            { field: "Country", type: "nominal", title: "Country" },
            { field: "Num Players", type: "quantitative" },
            { field: "Women", type: "quantitative" },
            { field: "% of Women", type: "quantitative" }
          ]
        }
      }
    ],
    config: {
      view: { stroke: "transparent" },
      title: { fontSize: 16 },
      legend: { labelFontSize: 11, titleFontSize: 12 }
    }
  };
}

// Mount the map and wire UI to Vega signals
async function initMap() {
  // build & embed
  const spec = buildMapSpec();

  // embed into map-inner
  const embedOpt = { actions: false, renderer: "svg" };
  try {
  const res = await vegaEmbed("#map-inner", "visuals/chess_map.vg.json", { actions: false, renderer: "svg" });
  mapView = res.view;

    // link controls to Vega signals
    const colorSelect = document.getElementById("map-color");
    const scaleInput = document.getElementById("circle-scale");
    const showCheckbox = document.getElementById("show-centroids");

    // initialize UI -> signals
    // mapColor values are the CSV header names; keep selection values as header text
    const initialColor = colorSelect.value;
    await mapView.signal("colorField", initialColor).runAsync();

    // show centroids
    await mapView.signal("showCentroids", showCheckbox.checked).runAsync();

    // wire change events
    colorSelect.addEventListener("change", async (e) => {
      const v = e.target.value;
      await mapView.signal("colorField", v).runAsync();
    });

    showCheckbox.addEventListener("change", async (e) => {
      await mapView.signal("showCentroids", e.target.checked).runAsync();
      await mapView.runAsync();
    });

    console.info("Map embedded and controls wired.");
  } catch (err) {
    console.error("Failed to embed map:", err);
    document.getElementById("map-inner").innerText = "Failed to load map (check console).";
  }
}

// small ISO3 → ISO2 map
const ISO3to2 = {
  "USA": "US", "RUS": "RU","CHN": "CN",  "IND": "IN",  "FRA": "FR",  "GER": "DE",
  "ENG": "GB",  "ESP": "ES",  "ITA": "IT",  "POL": "PL",  "BRA": "BR",  "CAN": "CA",
  "JPN": "JP",  "KOR": "KR",  "NED": "NL",  "SWE": "SE",  "UKR": "UA",  "DEU": "DE",
  "HUN": "HU",  "SRB": "RS",  "KHM": "KH",  "SSD": "SD",  "NGA": "NG",  "MMR": "MM",
  "LIE": "LI",  "NLD": "NL",  "BIH": "BA",  "GAB": "GA",  "CUB": "CU",  "IRN": "IR",
  "TUR": "TR",  "LKA": "LK",  "GRC": "GR", "VNM": "VN", "MNG":"MN", "MOZ": "MZ",
  "QAT":"QA", "SYC":"SC", "ARE": "AE", "TJK": "TJ", "GEO":"GE","TKM":"TM"
};

function parseMetricValue(raw, metric) {
  if (raw == null) {
    return null;
  }

  let num = raw.toString().trim();

  // remove commas and % symbols
  num = num.replace(/,/g,'').replace(/%/g,'');

  const val = Number(num);
  if (isNaN(val)) {
    return null;
  }

  return val;
}

async function buildToplist() {
  const listEl = document.getElementById("toplist");
  const headingEl = document.querySelector("#map-toplist h4");
  const captionEl = document.querySelector("#map-toplist .caption");

  listEl.innerHTML = '<li style="opacity:0.6;color:var(--muted)">Loading…</li>';

  const data = await loadCSV(STATS_CSV);
  if (!data) {
    listEl.innerHTML = '<li style="color:var(--muted)">Top list unavailable</li>';
    return;
  }

  const metricSelect = document.getElementById("map-color");
  const metric = metricSelect.value; // "FIDE Average", "% of Women", "Num Players"

  // update heading & caption dynamically
  let headingText = "", captionText = "";
  if(metric === "FIDE Average"){
    headingText = "Top 10 by Avg FIDE";
    captionText = "Top countries by average FIDE rating.";
  } else if(metric === "% of Women"){
    headingText = "Top 10 by % Women";
    captionText = "Top countries by percentage of female players.";
  } else if(metric === "Num Players"){
    headingText = "Top 10 by Total Players";
    captionText = "Top countries by total number of chess players.";
  }
  headingEl.textContent = headingText;
  captionEl.textContent = captionText;
  
  const rows = data.slice();
  for (const r of rows) {
    console.log("HERE idk",r.Country, r[metric], r);
  }
  rows.sort((a,b) => parseMetricValue(b[metric], metric) - parseMetricValue(a[metric], metric));

  for (const r of rows) {
    console.log("HERE idk",r.Country, r[metric]);
  }

  const top = rows.slice(0, TOPLIST_COUNT);
  listEl.innerHTML = "";

  top.forEach((r,i) => {
    const name = r.Country || "—";
    let value = r[metric] != null ? Number(r[metric]) : "—";

    // format numbers nicely
    if(metric === "% of Women") value = `${value.toFixed(0)}%`;
    else if(metric === "Num Players") value = value.toLocaleString();
    else value = Math.round(value);

    // determine 2-letter ISO code
    let iso2 = "";
    if (r.ISO2 && r.ISO2.length === 2) iso2 = r.ISO2;
    else if (r.id && r.id.length === 3 && ISO3to2[r.id.toUpperCase()]) iso2 = ISO3to2[r.id.toUpperCase()];

    const flagUrl = iso2 ? `https://flagcdn.com/w20/${iso2.toLowerCase()}.png` : "";

    const li = document.createElement("li");
    li.innerHTML = `
      <span class="rank">#${i+1}</span>
      ${flagUrl ? `<img class="flag" src="${flagUrl}" alt="${name} flag">` : ''}
      <span class="name">${name}</span>
      <span class="value">${value}</span>
    `;
    listEl.appendChild(li);
  });
}

// rebuild toplist whenever dropdown changes
document.getElementById("map-color").addEventListener("change", buildToplist);

// initial build
buildToplist();


/* small helpers: reveal-on-scroll and nav active */
function setupRevealAndNav() {
  // reveal
  const reveals = document.querySelectorAll(".reveal");
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) e.target.classList.add("visible");
    });
  }, { threshold: 0.12 });
  reveals.forEach(r => obs.observe(r));

  // smooth scroll and active nav
  const links = document.querySelectorAll(".nav-link");
  links.forEach(a => {
    a.addEventListener("click", (ev) => {
      ev.preventDefault();
      links.forEach(l => l.classList.remove("active"));
      a.classList.add("active");
      const id = a.getAttribute("href").slice(1);
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  });

  window.addEventListener("scroll", () => {
    const sections = ["map-section","timeline-section","pyramid-section","titles-section","about-section"];
    const sc = window.scrollY + 80;
    for (let id of sections) {
      const el = document.getElementById(id);
      if (!el) continue;
      const top = el.offsetTop;
      const bottom = top + el.offsetHeight;
      const link = document.querySelector(`a[href="#${id}"]`);
      if (sc >= top && sc < bottom) {
        if (link) { document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active")); link.classList.add("active"); }
      }
    }
  }, { passive:true });
}

(async function main(){
  initMap();
  buildToplist();
  setupRevealAndNav();
})();
</script>
</body>
</html>
