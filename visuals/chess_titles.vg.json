{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Chess Titles by Country and Average Player Age",
    "subtitle": "Stacked bars show title composition; right panel shows metric via dropdown",
    "color": "#d9b44a",
    "subtitleColor": "floralwhite",
    "anchor": "start",
    "fontSize": 20,
    "subtitleFontSize": 13
  },
  "background": "#0f1720",

  "data": {
    "url": "data/International_Chess_Stats.csv",
    "format": {
      "parse": {
        "GMs": "number",
        "IMs": "number",
        "FMs": "number",
        "WGMs": "number",
        "WIMs": "number",
        "WFMs": "number",
        "Age Avg": "number"
      }
    }
  },

  "params": [
    {
      "name": "color_metric",
      "value": "female_to_male_ratio"
    }
  ],

  "transform": [
    { "calculate": "datum.GMs + datum.IMs + datum.FMs + datum.WGMs + datum.WIMs + datum.WFMs", "as": "total_titled" },
    { "calculate": "datum.WGMs + datum.WIMs + datum.WFMs", "as": "female_titles" },
    { "calculate": "datum.GMs + datum.IMs + datum.FMs", "as": "male_titles" },
    { "calculate": "datum.male_titles > 0 ? datum.female_titles / datum.male_titles : 0", "as": "female_to_male_ratio" },
    { "calculate": "datum[color_metric]", "as": "validData" },
    { "filter": "datum.total_titled > 0" },
    { "window": [{ "op": "rank", "as": "rank" }], "sort": [{ "field": "total_titled", "order": "descending" }] },
    { "filter": "datum.rank <= 25" }
  ],

  "hconcat": [
    {
      "width": 950,
      "height": 650,
      "layer": [
        {
          "transform": [
            { "fold": ["FMs", "IMs", "GMs", "WFMs", "WIMs", "WGMs"], "as": ["title", "count"] }
          ],
          "mark": { "type": "bar", "cornerRadiusTopRight": 5, "cornerRadiusBottomRight": 5 },
          "encoding": {
            "y": {
              "field": "Country",
              "type": "ordinal",
              "sort": { "field": "total_titled", "order": "descending" },
              "axis": { "title": "", "labelColor": "white", "labelFontSize": 12, "ticks": false }
            },
            "x": {
              "aggregate": "sum",
              "field": "count",
              "type": "quantitative",
              "title": "Number of Titled Players",
              "axis": { "labelColor": "white", "titleColor": "white", "gridColor": "#333" },
              "scale": { "zero": true }
            },
            "color": {
              "field": "title",
              "type": "nominal",
              "scale": {
                "domain": ["GMs", "IMs", "FMs", "WIMs", "WGMs", "WFMs"],
                "range": ["#FFD700", "#C0C0C0", "#CD7F32", "#ff99cc", "#ffb3e6", "#ffcce6"]
              },
              "legend": { "title": "Title Type", "labelColor": "white", "titleColor": "white" }
            },
            "tooltip": [
              { "field": "Country", "type": "nominal" },
              { "field": "title", "type": "nominal", "title": "Title" },
              { "field": "count", "type": "quantitative", "title": "Players" }
            ]
          }
        }
      ]
    },
    {
      "title": {
        "text": "Colour Metric per Country",
        "color": "white"
      },
      "width": 80,
      "height": 650,
      "mark": "rect",
      "encoding": {
        "y": { "field": "Country", "type": "ordinal", "sort": { "field": "total_titled", "order": "descending" }, "axis": null },
        "color": {
          "field": "validData",
          "type": "quantitative",
          "scale": {
            "domain": null,
            "range": ["#222", "#b84dff"]
          },
          "legend": { "title": {"expr": "color_metric"}, "labelColor": "white", "titleColor": "white" }
        },
        "tooltip": [
          { "field": "Country", "type": "nominal" },
          { "field": "validData", "type": "quantitative", "title": {"expr": "color_metric"}, "format": ".2f" }
        ]
      }
    }
  ],

  "config": {
    "axis": { "domainColor": "#555", "gridColor": "#333" },
    "legend": { "labelFontSize": 12, "titleFontSize": 13 },
    "mark": { "tooltip": true }
  }
}
